<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ArchaeoGraph Frontend Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f5f5;
      color: #333;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }

    .graph-container {
      width: 100%;
      height: 50vh;
      min-height: 400px;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      background-color: white;
      margin-top: 1rem;
    }

    .query-form {
      background-color: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      max-height: 60vh;
      overflow: hidden;
    }

    .query-form-content {
      max-height: 50vh;
      overflow-y: auto;
      padding-right: 5px;
    }

    .query-form textarea {
      max-height: 200px;
      min-height: 100px;
      width: 100%;
    }

    .btn-primary {
      background-color: #4f46e5;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-primary:hover {
      background-color: #4338ca;
    }

    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4f46e5;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="min-h-screen bg-gray-50">
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">ArchaeoGraph</h1>
        <div class="text-sm text-gray-600">
          0 nodes • 0 edges
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
      <div class="query-form max-w-4xl mx-auto mt-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">ArangoDB Query</h2>

        <div class="query-form-content">
          <form class="space-y-4">
            <div>
              <label for="query" class="block text-sm font-medium text-gray-700 mb-1">
                Enter your AQL query:
              </label>
              <textarea
                id="query"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                rows="4"
                placeholder="FOR v, e, p IN 1..2 ANY 'nodeId' GRAPH 'cidoc_graph' RETURN {nodes: [v], edges: [e]}"
              ></textarea>
            </div>

            <div class="flex flex-wrap gap-2">
              <button
                type="button"
                onclick="setQueryExample1()"
                class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-md transition-colors"
              >
                Example 1
              </button>
              <button
                type="button"
                onclick="setQueryExample2()"
                class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-md transition-colors"
              >
                Example 2
              </button>
              <button
                type="button"
                onclick="setQueryExample3()"
                class="px-3 py-1 text-sm bg-gray-100 hover:bg-gray-200 rounded-md transition-colors"
              >
                Example 3
              </button>
            </div>

            <div class="flex justify-end">
              <button
                type="button"
                onclick="executeQuery()"
                class="btn-primary px-6 py-2 text-sm font-medium"
              >
                Execute Query
              </button>
            </div>
          </form>

          <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-md hidden" id="error-message">
            <h3 class="font-medium text-red-800">Query Error:</h3>
            <p class="text-red-600 text-sm mt-1" id="error-text"></p>
          </div>

          <div class="mt-6 p-4 bg-blue-50 border border-blue-100 rounded-md">
            <h3 class="font-medium text-blue-800 mb-2">Query Tips:</h3>
            <ul class="text-blue-600 text-sm space-y-1">
              <li>• Use <code class="bg-blue-100 px-1 rounded">FOR v, e, p IN 1..depth ANY 'nodeId' GRAPH 'graphName'</code> for traversals</li>
              <li>• <code class="bg-blue-100 px-1 rounded">RETURN {"{nodes: [v], edges: [e]}"}</code> format works best</li>
              <li>• Try limiting depth (1..2) for better performance</li>
              <li>• Use node IDs from your CIDOC CRM graph</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="mt-6 bg-white p-4 rounded-lg shadow-sm">
        <h2 class="text-lg font-medium text-gray-900 mb-3">Knowledge Graph Visualization</h2>

        <div class="graph-container">
          <div class="w-full h-full flex items-center justify-center">
            <p class="text-gray-500">Graph visualization will appear here when data is loaded</p>
          </div>
        </div>
      </div>

      <div class="h-20"></div>
    </main>

    <footer class="bg-white border-t mt-8 py-4">
      <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-500">
        ArchaeoGraph • CIDOC CRM Knowledge Graph • © 2026
      </div>
    </footer>
  </div>

  <!-- Add Vis.js for graph visualization -->
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <script>
    let network = null;
    const nodes = new vis.DataSet([]);
    const edges = new vis.DataSet([]);

    async function executeQuery() {
      const query = document.getElementById('query').value;
      const errorElement = document.getElementById('error-message');
      const errorText = document.getElementById('error-text');
      const graphContainer = document.querySelector('.graph-container');

      if (!query.trim()) {
        errorText.textContent = 'Please enter a query';
        errorElement.classList.remove('hidden');
        return;
      }

      try {
        // Show loading state
        document.querySelector('.btn-primary').disabled = true;
        document.querySelector('.btn-primary').textContent = 'Executing...';
        graphContainer.innerHTML = '<div class="loading-spinner"></div><p class="mt-4 text-gray-600">Loading graph data...</p>';

        // Call the actual API endpoint
        console.log('Executing query:', query);
        const response = await fetch('https://n8n.paulserver.dpdns.org/webhook-test/api/query_arango', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ query }),
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(`API request failed: ${response.status} ${response.statusText}\n${JSON.stringify(errorData)}`);
        }

        const result = await response.json();
        console.log('Query result:', result);

        // Update node/edge count
        document.querySelector('header div.text-sm').textContent = `${result.nodes?.length || 0} nodes • ${result.edges?.length || 0} edges`;

        // Clear previous data
        nodes.clear();
        edges.clear();

        // Add nodes to the dataset
        if (result.nodes && result.nodes.length > 0) {
          result.nodes.forEach(node => {
            nodes.add({
              id: node.id,
              label: node.label || node.id,
              title: `${node.type || 'Unknown'}\n${JSON.stringify(node.properties || {}, null, 2)}`,
              color: getNodeColor(node.type),
              shape: 'circle',
              size: 25,
            });
          });
        }

        // Add edges to the dataset
        if (result.edges && result.edges.length > 0) {
          result.edges.forEach(edge => {
            edges.add({
              from: edge.from,
              to: edge.to,
              label: edge.label,
              title: `${edge.label}\n${JSON.stringify(edge.properties || {}, null, 2)}`,
              color: {
                color: '#9ca3af',
                highlight: '#6b7280',
              },
              width: 1,
            });
          });
        }

        // Initialize or update the network
        if (!network) {
          const container = document.querySelector('.graph-container');
          const data = { nodes: nodes, edges: edges };
          const options = {
            nodes: {
              shape: 'circle',
              font: {
                size: 12,
                face: 'Inter',
              },
              borderWidth: 1,
              borderWidthSelected: 2,
              scaling: {
                min: 10,
                max: 30,
              },
            },
            edges: {
              font: {
                size: 10,
                face: 'Inter',
              },
              smooth: {
                enabled: true,
                type: 'continuous',
                roundness: 0.5,
              },
              arrows: {
                to: {
                  enabled: true,
                  type: 'arrow',
                },
              },
            },
            physics: {
              enabled: true,
              barnesHut: {
                gravitationalConstant: -80000,
                centralGravity: 0.3,
                springLength: 220,
                springConstant: 0.18,
                damping: 0.4,
                avoidOverlap: 0.1,
              },
              minVelocity: 0.75,
              solver: 'barnesHut',
            },
            interaction: {
              hover: true,
              navigationButtons: true,
              keyboard: true,
              hideEdgesOnDrag: true,
              tooltipDelay: 200,
            },
          };
          network = new vis.Network(container, data, options);

          // Add event handlers
          network.on('click', (params) => {
            if (params.nodes.length > 0) {
              const nodeId = params.nodes[0];
              const node = nodes.get(nodeId);
              if (node) {
                showNodeDetails(node);
              }
            }
          });
        } else {
          network.setData({ nodes: nodes, edges: edges });
        }

        // Show success
        errorElement.classList.add('hidden');
        console.log('Query executed successfully!');

      } catch (error) {
        console.error('Query error:', error);
        errorText.textContent = error.message || 'Failed to execute query';
        errorElement.classList.remove('hidden');
      } finally {
        // Reset button
        document.querySelector('.btn-primary').disabled = false;
        document.querySelector('.btn-primary').textContent = 'Execute Query';
      }
    }

    function getNodeColor(type) {
      const typeColors = {
        'E22_HumanMadeObject': '#4f46e5',
        'E53_Place': '#10b981',
        'E39_Actor': '#f59e0b',
        'E65_Creation': '#ef4444',
        'E31_Document': '#8b5cf6',
        'E18_PhysicalThing': '#3b82f6',
        'E5_Event': '#ec4899',
        'E55_Type': '#84cc16',
        'E42_Identifier': '#f97316',
        'E73_InformationObject': '#6366f1',
        'E9_Move': '#06b6d4',
        'default': '#6b7280',
      };
      return typeColors[type] || typeColors.default;
    }

    function showNodeDetails(node) {
      const detailsHtml = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white p-6 rounded-lg max-w-md mx-4">
            <h3 class="text-lg font-medium text-gray-900 mb-3">Node Details</h3>
            <div class="space-y-2 text-sm">
              <p><strong>ID:</strong> ${node.id}</p>
              <p><strong>Label:</strong> ${node.label}</p>
              <p><strong>Type:</strong> ${node.title?.split('\n')[0] || 'Unknown'}</p>
              <div class="mt-3">
                <h4 class="font-medium mb-1">Properties:</h4>
                <pre class="bg-gray-100 p-2 rounded text-xs overflow-auto max-h-40">${node.title?.split('\n').slice(1).join('\n') || 'No properties'}</pre>
              </div>
            </div>
            <button onclick="closeNodeDetails()" class="mt-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md">
              Close
            </button>
          </div>
        </div>
      `;

      const detailsElement = document.createElement('div');
      detailsElement.innerHTML = detailsHtml;
      detailsElement.id = 'node-details-modal';
      document.body.appendChild(detailsElement);
    }

    function closeNodeDetails() {
      const modal = document.getElementById('node-details-modal');
      if (modal) {
        modal.remove();
      }
    }

    function setQueryExample1() {
      document.getElementById('query').value = 'FOR v, e, p IN 1..2 ANY \"root\" GRAPH \"cidoc_graph\" RETURN {nodes: [v], edges: [e]}';
    }

    function setQueryExample2() {
      document.getElementById('query').value = 'FOR node IN cidoc_graph RETURN node';
    }

    function setQueryExample3() {
      document.getElementById('query').value = 'FOR v, e IN 1..1 OUTBOUND \"E22_Artifact_001\" GRAPH \"cidoc_graph\" RETURN {v, e}';
    }

    // Add some example data visualization
    console.log('ArchaeoGraph frontend loaded successfully!');
    console.log('API Endpoint:', 'https://n8n.paulserver.dpdns.org/webhook-test/api/query_arango');
  </script>
</body>
</html>